name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint:check

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist/
          retention-days: 1

  test:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build
          path: dist/

      - name: Setup Docker Images
        run: node dist/cli.js setup

      - name: Unit Tests
        run: bun test tests/unit/

      # Integration tests require Docker, which is avail on ubuntu-latest runners
      - name: Integration Tests
        run: bun test tests/integration/

      - name: Test Coverage
        run: bun run test:coverage

      - name: Download Main Branch Coverage
        if: github.event_name == 'pull_request'
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ci.yml
          branch: main
          name: coverage-report
          path: coverage-main/
        continue-on-error: true

      - name: Extract Coverage Percentages
        id: coverage
        run: |
          # Current branch coverage
          CURRENT=$(cat coverage/coverage-summary.json | jq '.total.lines.pct' | awk '{printf "%.2f", $1}')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          # Main branch coverage (if available)
          if [ -f coverage-main/coverage-summary.json ]; then
            MAIN=$(cat coverage-main/coverage-summary.json | jq '.total.lines.pct' | awk '{printf "%.2f", $1}')
            DIFF=$(echo "$CURRENT - $MAIN" | bc -l)
            echo "main=$MAIN" >> $GITHUB_OUTPUT
            echo "diff=$DIFF" >> $GITHUB_OUTPUT
          else
            echo "main=0" >> $GITHUB_OUTPUT
            echo "diff=0" >> $GITHUB_OUTPUT
          fi
          
          echo "Current: $CURRENT%"
          echo "Main: $MAIN%"
          echo "Diff: $DIFF%"

      - name: Generate Coverage Badge
        run: |
          COLOR=$(if [ $(echo "${{ steps.coverage.outputs.current }} >= 80" | bc -l) -eq 1 ]; then echo "brightgreen"; elif [ $(echo "${{ steps.coverage.outputs.current }} >= 50" | bc -l) -eq 1 ]; then echo "yellow"; else echo "red"; fi)
          curl -s "https://img.shields.io/badge/coverage-${{ steps.coverage.outputs.current }}%25-${COLOR}" -o coverage/coverage-badge.svg

      - name: Commit Coverage Badge
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update coverage badge [skip ci]"
          file_pattern: coverage/coverage-badge.svg
          skip_checkout: true
        continue-on-error: true

      - name: Generate Coverage Comparison Report
        if: github.event_name == 'pull_request'
        run: |
          cat > code-coverage-results.md << EOF
      ## Test Coverage Report

      | Branch | Coverage | Change |
      |--------|----------|--------|
      | This PR | ${{ steps.coverage.outputs.current }}% | - |
      | main | ${{ steps.coverage.outputs.main }}% | - |
      | **Diff** | - | ${{ steps.coverage.outputs.diff }}% |

      EOF
          
          # Add trend indicator
          DIFF=${{ steps.coverage.outputs.diff }}
          if [ $(echo "$DIFF > 0" | bc -l) -eq 1 ]; then
            echo "✅ Coverage **increased** by $DIFF%" >> code-coverage-results.md
          elif [ $(echo "$DIFF < 0" | bc -l) -eq 1 ]; then
            echo "⚠️ Coverage **decreased** by $(echo "$DIFF * -1" | bc -l)%" >> code-coverage-results.md
          else
            echo "➡️ Coverage unchanged" >> code-coverage-results.md
          fi

      - name: Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage/lcov.info
          badge: true
          fail_below_min: false
          format: markdown
          hide_branch_rate: false
          hide_complexity: false
          indicators: true
          output: both
          thresholds: "50 80"

      - name: Append Detailed Report
        if: github.event_name == 'pull_request'
        run: |
          if [ -f code-coverage-results.md ]; then
            echo "" >> code-coverage-results.md
            echo "## Detailed Coverage" >> code-coverage-results.md
            cat coverage/lcov.info >> code-coverage-results.md 2>/dev/null || true
          fi

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: code-coverage-results.md
          header: coverage-report

      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Toggle Test Status Labels
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Remove both labels first
          gh issue edit $PR_NUMBER --remove-label "tests:passing" --repo ${{ github.repository }} || true
          gh issue edit $PR_NUMBER --remove-label "tests:failing" --repo ${{ github.repository }} || true
          
          # Add appropriate label based on test result
          if [ ${{ job.status }} == 'success' ]; then
            gh issue edit $PR_NUMBER --add-label "tests:passing" --repo ${{ github.repository }}
          else
            gh issue edit $PR_NUMBER --add-label "tests:failing" --repo ${{ github.repository }}
          fi

  docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate docs
        run: bun run docs:validate

      - name: Check broken links
        run: bun run docs:broken-links
