name: Production Tests (Manual)

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'isol8 version to test (default: latest)'
        required: false
        default: 'latest'
      runBenchmarks:
        description: 'Run performance benchmarks'
        required: false
        default: 'true'
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install isol8 globally
        run: |
          bun i -g isol8@${{ github.event.inputs.version || 'latest' }}
          # Add bun global bin to PATH for subsequent steps
          echo "$(bun global bin)" >> $GITHUB_PATH
      
      - name: Verify Docker is running
        run: docker info
      
      - name: Setup isol8 images
        run: isol8 setup
        env:
          ISOL8_TEST_VERSION: ${{ github.event.inputs.version || 'latest' }}
      
      - name: Run production tests
        id: tests
        run: |
          set -o pipefail
          
          echo ""
          echo "=========================================="
          echo "Running Production Tests"
          echo "=========================================="
          cd apps/cli && bun test tests/production/ 2>&1 | tee ../../test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "Tests failed with exit code: $TEST_EXIT_CODE"
          fi
          
          PASS=$(grep -E "^\s+[0-9]+ pass" ../../test-output.log | grep -oE "[0-9]+" | head -1)
          FAIL=$(grep -E "^\s+[0-9]+ fail" ../../test-output.log | grep -oE "[0-9]+" | head -1)
          
          echo ""
          echo "=========================================="
          echo "Test Results"
          echo "=========================================="
          echo "Passed: ${PASS:-0}"
          echo "Failed: ${FAIL:-0}"
          
          echo "passed=${PASS:-0}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL:-0}" >> $GITHUB_OUTPUT
          
          # Write to job summary
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${PASS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${FAIL:-0} |" >> $GITHUB_STEP_SUMMARY
        env:
          ISOL8_TEST_VERSION: ${{ github.event.inputs.version || 'latest' }}

      - name: Run performance benchmarks
        if: github.event.inputs.runBenchmarks == 'true' && steps.tests.outputs.failed == '0'
        run: |
          echo ""
          echo "=========================================="
          echo "Running CLI Performance Benchmarks"
          echo "=========================================="
          cd packages/core && bun run benchmarks/tti.ts 2>&1 | tee ../../bench-output.log
          
          echo ""
          echo "=========================================="
          echo "Benchmark Results Summary"
          echo "=========================================="
          cd ../.. && python3 scripts/parse-bench-summary.py
          
          cat bench-summary.md >> $GITHUB_STEP_SUMMARY
        env:
          ISOL8_TEST_VERSION: ${{ github.event.inputs.version || 'latest' }}

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "Workflow Summary"
          echo "=========================================="
          echo "Version tested: ${{ github.event.inputs.version || 'latest' }}"
          echo "Tests: ${{ steps.tests.outputs.passed }} passed, ${{ steps.tests.outputs.failed }} failed"
          BENCH=${{ github.event.inputs.runBenchmarks }}
          if [ "$BENCH" = "true" ]; then
            echo "Benchmarks: Yes"
          else
            echo "Benchmarks: No"
          fi
          echo ""
          echo "=========================================="
          echo "Production Tests Completed!"
          echo "=========================================="
          
          # Write final summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ github.event.inputs.version || 'latest' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Passed | ${{ steps.tests.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Failed | ${{ steps.tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
