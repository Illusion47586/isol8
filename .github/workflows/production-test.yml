name: Production Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'isol8 version to test (default: latest)'
        required: false
        default: 'latest'
      runBenchmarks:
        description: 'Run performance benchmarks'
        required: false
        default: 'true'
        type: boolean

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Verify Docker is running
        run: docker info
      
      - name: Run production tests
        id: tests
        run: |
          echo ""
          echo "=========================================="
          echo "Running Production Tests"
          echo "=========================================="
          bun run test:prod 2>&1 | tee test-output.log
          
          PASS=$(grep -E "^\s+[0-9]+ pass" test-output.log | grep -oE "[0-9]+" | head -1)
          FAIL=$(grep -E "^\s+[0-9]+ fail" test-output.log | grep -oE "[0-9]+" | head -1)
          
          echo ""
          echo "=========================================="
          echo "Test Results"
          echo "=========================================="
          echo "Passed: ${PASS:-0}"
          echo "Failed: ${FAIL:-0}"
          
          echo "passed=${PASS:-0}" >> $GITHUB_OUTPUT
          echo "failed=${FAIL:-0}" >> $GITHUB_OUTPUT
          
          # Write to job summary
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${PASS:-0} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${FAIL:-0} |" >> $GITHUB_STEP_SUMMARY
        env:
          ISOL8_TEST_VERSION: ${{ github.event.inputs.version }}

      - name: Run performance benchmarks
        if: github.event.inputs.runBenchmarks == 'true' && steps.tests.outputs.failed == '0'
        run: |
          echo ""
          echo "=========================================="
          echo "Running CLI Performance Benchmarks"
          echo "=========================================="
          bun run bench:cli 2>&1 | tee bench-output.log
          
          echo ""
          echo "=========================================="
          echo "Benchmark Results Summary"
          echo "=========================================="
          python3 scripts/parse-bench-summary.py
          
          cat bench-summary.md >> $GITHUB_STEP_SUMMARY
        env:
          ISOL8_TEST_VERSION: ${{ github.event.inputs.version }}

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "Workflow Summary"
          echo "=========================================="
          echo "Version tested: ${{ github.event.inputs.version }}"
          echo "Tests: ${{ steps.tests.outputs.passed }} passed, ${{ steps.tests.outputs.failed }} failed"
          BENCH=${{ github.event.inputs.runBenchmarks }}
          if [ "$BENCH" = "true" ]; then
            echo "Benchmarks: Yes"
          else
            echo "Benchmarks: No"
          fi
          echo ""
          echo "=========================================="
          echo "Production Tests Completed!"
          echo "=========================================="
          
          # Write final summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Passed | ${{ steps.tests.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Failed | ${{ steps.tests.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
